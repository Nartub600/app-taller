<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>GPS | Taller</title>

        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,800,700,600,300' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
        <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.css">
        <link rel="stylesheet" href="css/gps-styles.css">

        <script type="text/javascript" src="cordova.js"></script>
        <script src="http://code.jquery.com/jquery-2.1.3.min.js"></script>
        <script src="bootstrap/js/bootstrap.js"></script>
        <script type="text/javascript" src="js/gpstaller.js"></script>
        <script>
            function onError(error) {
                alert('code: ' + error.code + '\n' + 'message: ' + error.message + '\n');
            }

            $(function(){
                var onSuccess = function(position) {
                    GPSTaller.search(position.coords.latitude, position.coords.longitude, function(data) {
                        if(data != null) {
                            var points = [];
                            for(i = 0; i < data.length; i++) {
                                points.push(new plugin.google.maps.LatLng(data[i].lat, data[i].lng));
                            }
                            var location = new plugin.google.maps.LatLngBounds(points);
                            GPSTaller.showMap(location.getCenter());
                            // GPSTaller.map.addEventListener(plugin.google.maps.event.MAP_READY, function() {
                            //     GPSTaller.addMarkers(data);
                            //     GPSTaller.map.animateCamera({
                            //         'target': location,
                            //         'duration': 500
                            //     });
                            // });
                        } else {
                            alert('No hay talleres cerca');
                        }
                    });
                };

                navigator.geolocation.getCurrentPosition(onSuccess, onError);

                $('#btn_search').on('click', function(e){
                    e.preventDefault();

                    var request = {
                        'address': $("#txt_search").val()
                    };

                    plugin.google.maps.Geocoder.geocode(request, function(results) {
                        if (results.length) {
                            var result = results[0];
                            var position = result.position;

                            GPSTaller.search(position.lat, position.lng, function(data) {
                                if(data != null) {
                                    var points = [];
                                    for(i = 0; i < data.length; i++) {
                                        points.push(new plugin.google.maps.LatLng(data[i].lat, data[i].lng));
                                    }
                                    var location = new plugin.google.maps.LatLngBounds(points);
                                    GPSTaller.map.clear();
                                    // GPSTaller.showMap(location.getCenter());
                                    // map.addEventListener(plugin.google.maps.event.MAP_READY, function() {
                                        GPSTaller.addMarkers(data);
                                        GPSTaller.map.animateCamera({
                                            'target': location,
                                            'duration': 500
                                        });
                                    // });
                                } else {
                                    alert('No hay talleres cerca');
                                }
                            });
                        } else {
                            alert('No se encuentra');
                        }
                    });
                });

                $('#txt_search').on('keypress', function(e){
                    if(e.which == 13) {
                        e.preventDefault();
                        $('#btn_search').trigger('click');
                        $('#txt_search').trigger('blur');
                    }
                });

            });

            // document.addEventListener("deviceready", function() {

            // }, false);
        </script>
    </head>
    <body>
        <div class="container">

            <div class="row">
                <header>
                    <a href="index.html" style="display: block;" show><img class="logo" src="img/logo.png" /></a>
                    <div class="line-01"></div>
                </header>
            </div>

            <div class="row">
                <div class="content-search col-lg-6">
                    <div class="input-group">
                        <span class="input-group-btn">
                            <button id="btn_search" class="btn btn-search" type="button"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
                        </span>
                        <input id="txt_search" type="text" class="form-control" placeholder="Search for...">
                    </div>
                </div>
            </div>

            <div id="map_canvas" class="row content-mapa">

            </div>

        </div>
    </body>
</html>
